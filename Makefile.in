#
# Autoconf + autoscan approache (no libtool / automake combination)
# Inspired by http://www.sax.de/unix-stammtisch/docs/autotools/autotools.html
#

TOP     := @srcdir@
SRC     := $(TOP)/src
TEST    := $(TOP)/test
BUILD   := $(CURDIR)/build
INCLUDE := $(TOP)/include

TARGET_CC      := @CC@
TARGET_AR      := @AR@
TARGET_CFLAGS  := @CFLAGS@ -Wall -Wextra -D_GNU_SOURCE -DNDEBUG -MD -I$(INCLUDE)
TARGET_LDFLAGS := @LDFLAGS@ -L$(BUILD)

SHELL        := @SHELL@
MKDIR_P      := @MKDIR_P@
INSTALL      := @INSTALL@

prefix       := @prefix@
exec_prefix  := @exec_prefix@
bindir       := @bindir@
libdir       := @libdir@
includedir   := @includedir@

test_bin := cute_test_success cute_test_abort cute_test_freeze cute_test_segv \
            cute_test_term cute_test_fail cute_test_assert \
            cute_test_root_suite cute_test_complex_suite cute_test_pnp_suite
lib_src  := core.c posix.c report.c
headers  := cute/cute.h cute/utils.h

.PHONY: all
all: $(BUILD)/libcute.a $(BUILD)/libcute.so

.PHONY: test
test: $(addprefix $(BUILD)/static/,$(test_bin)) \
      $(addprefix $(BUILD)/shared/,$(test_bin))

.PHONY: install
install: install-lib

.PHONY: install-lib
install-lib: $(BUILD)/libcute.a $(BUILD)/libcute.so
	echo $(INSTALL) -D -t $(DESTDIR)$(libdir) $^

.PHONY: install-include
install-include: $(addprefix $(DESTDIR)$(includedir)/,$(headers))

.PHONY: clean
clean:
	find $(BUILD) \( -name "*.[oda]" -o -name "*.so" \) -delete

.PHONY: distclean
distclean: clean
	$(RM) Makefile config.h config.log config.status stamp-h1

# Install header
$(DESTDIR)$(includedir)/%.h: $(INCLUDE)/%.h
	echo $(INSTALL) -D $< $@

# Build test with static libcute (use shared version for all other libs )
$(BUILD)/static/%: $(BUILD)/%.o $(BUILD)/libcute.a
	$(TARGET_CC) $(TARGET_CFLAGS) $(TARGET_LDFLAGS) \
		-Wl,--strip-all -T $(SRC)/cute.ld \
		-o $@ $(filter %.o,$^) -Wl,-static -lcute -Wl,-Bdynamic

# Build tests linked with shared libraries
$(BUILD)/shared/%: $(BUILD)/%.o $(BUILD)/libcute.so
	$(TARGET_CC) $(TARGET_CFLAGS) $(TARGET_LDFLAGS) \
		-Wl,--strip-all -T $(SRC)/cute.ld \
		-o $@ $(filter %.o,$^) -Wl,-Bdynamic -lcute

$(BUILD)/%.o: $(TEST)/%.c | $(BUILD)
	$(TARGET_CC) $(TARGET_CFLAGS) -o $@ -c $<

$(BUILD)/%.a: $(addprefix $(BUILD)/static/,$(lib_src:.c=.o))
	$(TARGET_AR) crs $@ $(filter-out %.h,$^)

$(BUILD)/static/%.o: $(SRC)/%.c | $(BUILD)/static
	$(TARGET_CC) $(TARGET_CFLAGS) -o $@ -c $<

$(BUILD)/%.so: $(addprefix $(BUILD)/shared/,$(lib_src:.c=.o))
	$(TARGET_CC) $(TARGET_CFLAGS) -shared -fpic -o $@ $(filter-out %.h,$^)

$(BUILD)/shared/%.o: $(SRC)/%.c | $(BUILD)/shared
	$(TARGET_CC) $(TARGET_CFLAGS) -fpic -o $@ -c $<

$(BUILD) $(BUILD)/static $(BUILD)/shared:
	$(MKDIR_P) $@

.SECONDARY:

-include $(wildcard $(BUILD)/static/*.d)
-include $(wildcard $(BUILD)/shared/*.d)
